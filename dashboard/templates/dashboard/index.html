<!DOCTYPE html>
<html>
<head>
    <title>SmartField Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .trait-box {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .âœ”ï¸ { background-color: #d4edda; }
        .â³ { background-color: #fff3cd; }
        .âŒ { background-color: #f8d7da; }
        .ğŸ•“ { background-color: #e2e3e5; }
        .legend { margin-top: 10px; }
        .legend span { margin-right: 15px; }
        button {
            padding: 6px 12px;
            margin: 4px;
            font-size: 14px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .summary-row td {
            font-weight: bold;
            background-color: #f1f1f1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
{% load filters %}
<h1>SmartField Supervisor Dashboard</h1>
<div style="margin: 10px 0;">
  <a href="{% url 'trait_status_table' %}">ğŸ” View Trait Status Table</a> |
  <a href="{% url 'field_visualization' %}">ğŸŒ¾ Visualize Field Plots</a> |
  <a href="{% url 'trait_heatmap' %}">ğŸ§¬ Trait Heatmap View</a> |
  <a href="{% url 'plot_planting_dates' %}">ğŸ“… Edit Planting Dates</a>
  
   


</div>

{% if user.is_authenticated %}
  <p>Logged in as {{ user.username }} | <a href="{% url 'logout' %}">Logout</a></p>
{% endif %}

<div style="margin: 10px 0;">
  <a href="/upload/"><button>ğŸ“¤ Upload SmartField CSV</button></a>
  <a href="/upload-schedule/"><button>ğŸ—“ï¸ Upload Trait Schedule</button></a>
  {% if headers %}
  <form method="get" action="/export/" style="display:inline;">
    <button type="submit">ğŸ“¥ Download Trait Status CSV</button>
  </form>
  {% endif %}
</div>

{% if headers %}
  <label for="traitFilter">Filter by Trait:</label>
  <select id="traitFilter" onchange="filterTraitTable()">
    <option value="">-- Show All --</option>
    {% for trait in trait_flags|get_first_value_keys %}
      <option value="{{ trait }}">{{ trait }}</option>
    {% endfor %}
  </select>

 <h2>Trait Status by Plot</h2>
<table id="traitTable" border="1">
  <tr>
    <th>Plant ID</th>
    {% for trait in trait_flags|get_first_value_keys %}
      <th class="trait-col" data-trait="{{ trait }}">{{ trait }}</th>
    {% endfor %}
  </tr>
  {% for pid, flags in trait_flags.items %}
    <tr onclick="openModal('{{ pid }}')">
      <td><a href="{% url 'plant_snapshot' pid %}" style="text-decoration:none;">{{ pid }}</a></td>
      {% for trait, status in flags.items %}
        <td class="trait-col" data-trait="{{ trait }}">
          <span class="trait-box {{ status }}" title="Due: {{ trait_due_dates|get_item:pid|get_item:trait }}">
            {{ status }}
          </span>
        </td>
      {% endfor %}
    </tr>
  {% endfor %}

      </tr>
        {% if trait_summary %}
    <tr class="summary-row">
      <td>Summary</td>
      {% for trait in trait_flags|get_first_value_keys %}
        <td>
          âœ”ï¸ {{ trait_summary|get_nested:trait|get_item:"âœ”ï¸" }},
          â³ {{ trait_summary|get_nested:trait|get_item:"â³" }},
          âŒ {{ trait_summary|get_nested:trait|get_item:"âŒ" }},
          ğŸ•“ {{ trait_summary|get_nested:trait|get_item:"ğŸ•“" }}
        </td>
      {% endfor %}
    </tr>
    {% endif %}
  </table>

  <div class="legend">
    <strong>Legend:</strong>
    <span class="trait-box âœ”ï¸">âœ”ï¸ Completed</span>
    <span class="trait-box â³">â³ Due Soon</span>
    <span class="trait-box âŒ">âŒ Overdue</span>
    <span class="trait-box ğŸ•“">ğŸ•“ Too Early</span>
  </div>

  <!-- Modal for editing traits -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Edit Trait Values for Plant: <span id="modalTitle"></span></h3>
      <form id="editForm">
        <table id="editTable" border="1">
          <tr>
            <th>Trait</th>
            <th>Status</th>
            <th>New Value</th>
          </tr>
        </table>
        <button type="submit">ğŸ’¾ Save Changes</button>
      </form>
    </div>
  </div>

  <h2>Trait Completeness per Plot</h2>
  <canvas id="plotChart" width="800" height="400"></canvas>

  <h2>Summary of Plot Completion</h2>
  <canvas id="summaryChart" width="400" height="400"></canvas>

  <script>
    const plotLabels = {{ plot_labels|safe }};
    const plotData = {{ plot_data|safe }};
    const plotColors = {{ plot_colors|safe }};
    const summaryLabels = ["Complete", "Incomplete", "Empty"];
    const summaryData = {{ summary_data|safe }};
    const rawTraitData = {{ trait_flags|safe }};

    new Chart(document.getElementById('plotChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: plotLabels,
        datasets: [{
          label: 'Completed Traits',
          data: plotData,
          backgroundColor: plotColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Per-Plot Trait Completeness' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    new Chart(document.getElementById('summaryChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: summaryLabels,
        datasets: [{
          label: 'Plot Status',
          data: summaryData,
          backgroundColor: ['green', 'orange', 'red']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: 'Plot Completion Summary' }
        }
      }
    });

    function filterTraitTable() {
      const selectedTrait = document.getElementById("traitFilter").value;
      const cols = document.querySelectorAll(".trait-col");
      cols.forEach(col => {
        col.style.display = (!selectedTrait || col.dataset.trait === selectedTrait) ? '' : 'none';
      });
    }

    function openModal(plantId) {
      document.getElementById("modal").style.display = "block";
      document.getElementById("modalTitle").innerText = plantId;

      const traitData = rawTraitData[plantId];
      const table = document.getElementById("editTable");
      table.innerHTML = '<tr><th>Trait</th><th>Status</th><th>New Value</th></tr>';

      for (let trait in traitData) {
        const row = table.insertRow(-1);
        row.insertCell(0).innerText = trait;
        row.insertCell(1).innerText = traitData[trait];
        const input = document.createElement("input");
        input.type = "text";
        input.name = trait;
        row.insertCell(2).appendChild(input);
      }
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    document.getElementById("editForm").onsubmit = async function(e) {
      e.preventDefault();
      const plantId = document.getElementById("modalTitle").innerText;
      const formData = new FormData(this);
      const edits = { [plantId]: {} };
      for (const [key, value] of formData.entries()) {
        if (value.trim()) {
          edits[plantId][key] = value.trim();
        }
      }

      const response = await fetch("/save-edits/", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ edits })
      });

      const result = await response.json();
      alert(result.status === "success" ? "âœ… Saved!" : "âŒ Failed: " + result.message);
      if (result.status === "success") location.reload();
    };

    // ğŸ” Dynamic Trait History on Click
    async function fetchTraitHistory(plantId, trait, targetRow) {
      const res = await fetch(`/plant-history/${plantId}`);
      const json = await res.json();
      const history = (json.traits && json.traits[trait]) || [];
      const existing = document.getElementById("history-row");
      if (existing) existing.remove();

      const historyRow = document.createElement("tr");
      historyRow.id = "history-row";
      const cell = document.createElement("td");
      cell.colSpan = 3;
      cell.innerHTML = "<strong>History:</strong><br>" + (
        history.length
          ? history.map(h => `${h.value} by ${h.user} at ${h.timestamp}`).join("<br>")
          : "No history"
      );
      cell.style.background = "#f8f9fa";
      historyRow.appendChild(cell);
      targetRow.parentNode.insertBefore(historyRow, targetRow.nextSibling);
    }

    document.getElementById("editTable").addEventListener("click", function(e) {
      if (e.target.tagName === "TD" && e.target.cellIndex !== 2) {
        const row = e.target.closest("tr");
        const plantId = document.getElementById("modalTitle").innerText;
        const trait = row.cells[0].innerText;
        fetchTraitHistory(plantId, trait, row);
      }
    });
  </script>
{% endif %}
</body>
</html>
